name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    outputs:
      jar-path: ${{ steps.set-jar-path.outputs.jar-path }}

    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
      - name: Checkout code
        uses: actions/checkout@v4

      # –®–∞–≥ 2: –ö–≠–®–ò–†–û–í–ê–ù–ò–ï Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            !~/.m2/repository/**/*.lock  # –ò—Å–∫–ª—é—á–∞–µ–º lock-—Ñ–∞–π–ª—ã
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-

      # –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Java —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º Maven
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven

      # –®–∞–≥ 4: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à)
      - name: Download dependencies
        run: mvn dependency:go-offline --no-transfer-progress -B

      # –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (–¥–æ —Å–±–æ—Ä–∫–∏)
      - name: Run tests
        run: mvn test --no-transfer-progress -B

      # –®–∞–≥ 6: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–µ—Å—Ç—ã —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω—ã)
      - name: Build with Maven
        run: mvn clean package --no-transfer-progress -DskipTests -B

      # –®–∞–≥ 7: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ JAR
      - name: Save JAR path
        id: set-jar-path
        run: echo "jar-path=target/configCICD-0.0.1-SNAPSHOT.jar" >> $GITHUB_OUTPUT

      # –®–∞–≥ 8: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: configCICD-jar
          path: target/configCICD-0.0.1-SNAPSHOT.jar
          retention-days: 7

      # –®–∞–≥ 9: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
          echo "JAR-—Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç"
          echo "–ö—ç—à –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå –°–±–æ—Ä–∫–∞ –∏–ª–∏ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π!"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"

  # –£—Å–ª–æ–≤–Ω—ã–µ job'—ã —Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏
  build-and-push-docker:
    needs: build-and-test
    runs-on: ubuntu-latest
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ main, –Ω–µ –¥–ª—è PR
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: configCICD-jar
          path: target/

      # –ö—ç—à –¥–ª—è Docker —Å–ª–æ–µ–≤
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: |
            image=moby/buildkit:latest
          buildkitd-flags: --debug

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_NAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_NAME }}/configcicd:latest
            ${{ secrets.DOCKERHUB_NAME }}/configcicd:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          platforms: linux/amd64

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  deploy:
    needs: build-and-push-docker
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy on VM via host machine
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MY_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 50000
          script: |
            echo "üîÑ Pulling latest Docker image..."
            docker pull ${{ secrets.DOCKERHUB_NAME }}/configcicd:latest
            
            echo "üõë Stopping existing container..."
            docker stop configCICD || true
            docker rm configCICD || true
            
            echo "üßπ Cleaning up unused images..."
            docker image prune -af --filter "until=24h"
            
            echo "üöÄ Starting new container..."
            docker run -d \
              --name configCICD \
              --restart unless-stopped \
              -p 8080:8080 \
              -e "SPRING_PROFILES_ACTIVE=prod" \
              ${{ secrets.DOCKERHUB_NAME }}/configcicd:latest
            
            echo "‚è≥ Waiting for application to start..."
            sleep 10
            
            echo "üîç Checking container status..."
            docker ps --filter "name=configCICD" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo "‚úÖ Deployment completed successfully!"
